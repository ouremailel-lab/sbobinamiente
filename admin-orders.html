<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestione Ordini</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #b2e0fb 0%, #e0c3fc 40%, #f9f586 80%, #b7f7c8 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fffefc;
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 10px 40px rgba(74,144,226,0.10);
        }
        h1 {
            color: #4a90e2;
            margin-bottom: 24px;
            font-size: 2em;
        }
        .login-section {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        .login-section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #4a90e2;
            margin-bottom: 6px;
        }
        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1.5px solid #e0c3fc;
            border-radius: 10px;
            font-size: 1em;
            background: #f7faff;
        }
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #b2e0fb 0%, #e0c3fc 50%, #b7f7c8 100%);
            color: #4a90e2;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.02);
        }
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #e0c3fc;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #4a90e2;
            width: auto;
        }
        .filter-btn.active {
            background: linear-gradient(90deg, #b2e0fb 0%, #e0c3fc 100%);
            color: white;
            border-color: #b2e0fb;
        }
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #e0c3fc;
            box-shadow: 0 2px 8px rgba(74,144,226,0.05);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .order-id {
            font-weight: 700;
            color: #4a90e2;
            font-size: 1.1em;
        }
        .order-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .order-details {
            margin: 12px 0;
        }
        .order-details p {
            margin: 6px 0;
            color: #475569;
        }
        .order-items {
            background: #f7faff;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }
        .order-item {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .btn-confirm {
            flex: 1;
            padding: 10px;
            background: linear-gradient(90deg, #b7f7c8 0%, #b2e0fb 100%);
            color: #155724;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-cancel {
            flex: 1;
            padding: 10px;
            background: #f8d7da;
            color: #721c24;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-view {
            padding: 10px 16px;
            background: #e0c3fc;
            color: #4a90e2;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #e879a3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <h2>üîê Admin Login</h2>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label>Password Admin:</label>
                <input type="password" id="adminPassword" required>
            </div>
            <button type="submit">Accedi</button>
        </form>
        <p style="margin-top: 12px; color: #888; font-size: 0.9em;">Inserisci la password per accedere al pannello admin</p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display: none;">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <div class="container">
            <h1>üì¶ Gestione Ordini</h1>
            
            <div class="filters">
                <button class="filter-btn active" onclick="filterOrders('all')">Tutti</button>
                <button class="filter-btn" onclick="filterOrders('pending')">In Attesa</button>
                <button class="filter-btn" onclick="filterOrders('confirmed')">Confermati</button>
                <button class="filter-btn" onclick="filterOrders('cancelled')">Annullati</button>
            </div>

            <div id="ordersContainer">
                <div class="empty-state">
                    <p style="font-size: 1.2em; color: #4a90e2;">Caricamento ordini...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="products-data.js"></script>
    <script>
        // Inizializza EmailJS
        emailjs.init('XhJ4ib2UUOt20rMxV');

        const ADMIN_PASSWORD = 'ElisaLuigi2agosto!';
        const TOKEN_EXPIRY_DAYS = 7;
        let currentFilter = 'all';

        // Login
        function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                showAdminPanel();
            } else {
                alert('‚ùå Password errata!');
            }
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadOrders();
        }

        function logout() {
            location.reload();
        }

        // Check auth on load (password richiesta ad ogni accesso)
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        });

        // Carica ordini (da localStorage e Supabase)
        async function loadOrders() {
            try {
                const normalizeOrder = (order, sourceKey) => {
                    const itemsArray = Array.isArray(order.items)
                        ? order.items
                        : (order.items ? [order.items] : []);

                    const customerInfo = order.deliveryInfo || order.delivery_info || {};
                    const customerEmail = customerInfo.email || order.user_email || order.userEmail || order.email || '';
                    const customerName =
                        customerInfo.nome || order.user_name || order.userName || order.nome || '';

                    const normalizedStatus =
                        order.status === 'pagato' || order.status === 'completed'
                            ? 'confirmed'
                            : (order.status || (sourceKey === 'pendingOrders' ? 'pending' : 'confirmed'));

                    return {
                        ...order,
                        id: order.id || order.orderId || order.order_id || order.session_id || `ORD-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                        orderId: order.orderId || order.order_id || order.id || order.session_id,
                        orderDate: order.orderDate || order.order_date || order.date || order.timestamp || new Date().toISOString(),
                        timestamp: order.timestamp || new Date(order.orderDate || order.order_date || order.date || Date.now()).getTime(),
                        status: normalizedStatus,
                        items: itemsArray,
                        total: Number(order.total || order.amount || order.totale || 0),
                        deliveryInfo: {
                            nome: customerInfo.nome || customerName || 'N/A',
                            cognome: customerInfo.cognome || '',
                            email: customerEmail || 'N/A',
                            cellulare: customerInfo.cellulare || customerInfo.telefono || 'N/A',
                            indirizzo: customerInfo.indirizzo || 'N/A',
                            citta: customerInfo.citta || 'N/A'
                        },
                        email: customerEmail || order.email || 'N/A'
                    };
                };

                const parseOrdersFromKey = (key) => {
                    try {
                        const raw = localStorage.getItem(key);
                        if (!raw) return [];
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) return parsed;
                        if (parsed && Array.isArray(parsed.orders)) return parsed.orders;
                        return [];
                    } catch {
                        return [];
                    }
                };

                const pendingOrders = parseOrdersFromKey('pendingOrders').map(order => normalizeOrder(order, 'pendingOrders'));

                const confirmedOrders = parseOrdersFromKey('orders').map(order => normalizeOrder(order, 'orders'));

                const completedOrders = parseOrdersFromKey('completedOrders').map(order => normalizeOrder(order, 'completedOrders'));

                const orderHistory = parseOrdersFromKey('orderHistory').map(order => normalizeOrder(order, 'orderHistory'));

                const allOrders = [
                    ...pendingOrders,
                    ...confirmedOrders,
                    ...completedOrders,
                    ...orderHistory
                ];

                const sourceStats = {
                    pendingOrders: pendingOrders.length,
                    orders: confirmedOrders.length,
                    completedOrders: completedOrders.length,
                    orderHistory: orderHistory.length
                };
                window.__adminOrdersSourceStats = sourceStats;
                console.log('üìä Source ordini:', sourceStats);

                const uniqueOrdersMap = new Map();
                allOrders.forEach(order => {
                    const key = [
                        order.id || order.orderId || '',
                        order.timestamp || order.orderDate || order.date || '',
                        order.session_id || '',
                        order.deliveryInfo?.email || order.userEmail || order.email || '',
                        order.total || '',
                        Array.isArray(order.items) ? order.items.length : 0
                    ].join('|');
                    if (!uniqueOrdersMap.has(key)) uniqueOrdersMap.set(key, order);
                });

                const localOrders = Array.from(uniqueOrdersMap.values()).sort((a, b) => {
                    const dateA = new Date(a.orderDate || a.timestamp || 0).getTime();
                    const dateB = new Date(b.orderDate || b.timestamp || 0).getTime();
                    return dateB - dateA;
                });
                
                // TODO: Se hai Supabase configurato, carica anche da l√¨
                // const supabaseOrders = await loadFromSupabase();
                
                displayOrders(localOrders);
            } catch (error) {
                console.error('Errore caricamento ordini:', error);
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="empty-state">
                        <p style="color: #e879a3;">Errore nel caricamento degli ordini</p>
                    </div>
                `;
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            // Filtra ordini
            let filteredOrders = orders;
            if (currentFilter !== 'all') {
                filteredOrders = orders.filter(o => o.status === currentFilter);
            }

            if (filteredOrders.length === 0) {
                const stats = window.__adminOrdersSourceStats || {};
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 1.2em; color: #888;">üì≠ Nessun ordine trovato</p>
                        <p style="font-size: 0.95em; color: #94a3b8; margin-top: 8px;">Sorgenti: pendingOrders=${stats.pendingOrders || 0}, orders=${stats.orders || 0}, completedOrders=${stats.completedOrders || 0}, orderHistory=${stats.orderHistory || 0}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredOrders.forEach(order => {
                const statusClass = `status-${order.status || 'pending'}`;
                const statusText = {
                    'pending': 'In Attesa Pagamento',
                    'confirmed': 'Confermato',
                    'cancelled': 'Annullato'
                }[order.status || 'pending'];

                html += `
                    <div class="order-card" data-status="${order.status || 'pending'}">
                        <div class="order-header">
                            <div class="order-id">Ordine #${order.id || order.orderId || 'N/A'}</div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="order-details">
                            <p><strong>üìÖ Data:</strong> ${new Date(order.orderDate || order.timestamp || Date.now()).toLocaleString('it-IT')}</p>
                            <p><strong>üë§ Cliente:</strong> ${order.deliveryInfo?.nome || 'N/A'} ${order.deliveryInfo?.cognome || ''}</p>
                            <p><strong>üìß Email:</strong> ${order.deliveryInfo?.email || order.email || 'N/A'}</p>
                            <p><strong>üì± Tel:</strong> ${order.deliveryInfo?.cellulare || 'N/A'}</p>
                            <p><strong>üìç Indirizzo:</strong> ${order.deliveryInfo?.indirizzo || 'N/A'}, ${order.deliveryInfo?.citta || 'N/A'}</p>
                            <p><strong>üí∞ Totale:</strong> <span style="color: #4a90e2; font-weight: 700; font-size: 1.1em;">${order.total || '0.00'}‚Ç¨</span></p>
                        </div>
                        <div class="order-items">
                            <strong>üì¶ Articoli:</strong>
                            ${(order.items || []).map(item => `
                                <div class="order-item">
                                    <span>${item.title || item.titolo || 'Prodotto'} ${item.tipo === 'digitale' ? '(PDF)' : '(Cartaceo)'}</span>
                                    <span>${item.quantity || 1}x ${item.prezzo || '0.00'}‚Ç¨</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-actions">
                            ${order.status !== 'confirmed' ? `
                                <button class="btn-confirm" onclick="confirmOrder('${order.id || order.orderId}')">
                                    ‚úÖ Conferma Pagamento e Invia PDF
                                </button>
                            ` : `
                                <button class="btn-view" onclick="viewOrderDetails('${order.id || order.orderId}')">
                                    üìÑ Vedi Dettagli
                                </button>
                            `}
                            ${order.status !== 'cancelled' ? `
                                <button class="btn-cancel" onclick="cancelOrder('${order.id || order.orderId}')">
                                    ‚ùå Annulla
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadOrders();
        }

        async function createPdfToken({ orderId, productId, email }) {
            const response = await fetch('/api/create-pdf-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderId: orderId,
                    productId: productId,
                    email: email,
                    expiryDays: TOKEN_EXPIRY_DAYS
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Errore nella creazione del link PDF');
            }

            return response.json();
        }

        // Conferma ordine e invia PDF
        async function confirmOrder(orderId) {
            if (!confirm('Confermare il pagamento e inviare i PDF al cliente?')) return;

            try {
                const orders = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
                const order = orders.find(o => (o.id || o.orderId) === orderId);
                
                if (!order) {
                    alert('‚ùå Ordine non trovato');
                    return;
                }

                // Filtra solo i PDF digitali
                const pdfItems = (order.items || []).filter(item => item.tipo === 'digitale');
                
                if (pdfItems.length === 0) {
                    // Solo prodotti fisici, conferma senza inviare PDF
                    order.status = 'confirmed';
                    localStorage.setItem('pendingOrders', JSON.stringify(orders));
                    alert('‚úÖ Ordine confermato (nessun PDF da inviare)');
                    loadOrders();
                    return;
                }

                // Estrai e valida email
                const recipientEmail = (order.deliveryInfo?.email || order.email || '').trim();
                
                // Validazione email
                if (!recipientEmail || !recipientEmail.includes('@')) {
                    alert('‚ùå Email destinatario non valida: ' + recipientEmail);
                    return;
                }

                const sessionId = order.id || order.orderId || Date.now().toString();

                const tokenResponses = await Promise.all(
                    pdfItems.map(item => createPdfToken({
                        orderId: sessionId,
                        productId: item.id,
                        email: recipientEmail
                    }))
                );

                const pdfAccesses = pdfItems.map((item, index) => {
                    const tokenData = tokenResponses[index];
                    return {
                        productName: item.title || item.titolo,
                        accessUrl: `https://www.sbobinamente.it/viewer-pdf.html?token=${tokenData.token}&product=${item.id}`,
                        expiryDate: new Date(tokenData.expiresAt).toLocaleDateString('it-IT')
                    };
                });

                // Invia email con EmailJS
                const emailData = {
                    to_email: recipientEmail,
                    to_name: `${order.deliveryInfo?.nome || ''} ${order.deliveryInfo?.cognome || ''}`.trim() || 'Cliente',
                    order_id: orderId,
                    order_date: new Date(order.orderDate || Date.now()).toLocaleDateString('it-IT'),
                    pdf_list: pdfAccesses.map(pdf => 
                        `${pdf.productName}\nüîó Link: ${pdf.accessUrl}\n‚è∞ Valido fino al: ${pdf.expiryDate}\nüîí Link personale (valido solo sul primo dispositivo)`
                    ).join('\n\n'),
                    total: order.total
                };

                console.log('üìß Invio email con dati:', emailData);
                console.log('üìß Email destinatario:', recipientEmail);

                const response = await emailjs.send(
                    'service_r952gjr',
                    'template_kk0bj9l',
                    emailData
                );

                console.log('‚úÖ Email inviata:', response);

                // Aggiorna stato ordine
                order.status = 'confirmed';
                order.confirmedAt = new Date().toISOString();
                order.pdfAccesses = pdfAccesses;
                localStorage.setItem('pendingOrders', JSON.stringify(orders));

                alert('‚úÖ Pagamento confermato! Email con PDF inviata al cliente.');
                loadOrders();

            } catch (error) {
                console.error('‚ùå Errore completo:', error);
                console.error('Status:', error?.status);
                console.error('Text:', error?.text);
                console.error('Message:', error?.message);
                
                let msg = '‚ùå Errore nell\'invio dell\'email.\n\n';
                if (error?.status) msg += `Status: ${error.status}\n`;
                if (error?.text) msg += `Messaggio: ${error.text}\n`;
                if (error?.message) msg += `Errore: ${error.message}\n`;
                msg += '\nApri la console per dettagli completi.';
                
                alert(msg);
            }
        }

        function cancelOrder(orderId) {
            if (!confirm('Annullare questo ordine?')) return;

            const orders = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
            const order = orders.find(o => (o.id || o.orderId) === orderId);
            
            if (order) {
                order.status = 'cancelled';
                localStorage.setItem('pendingOrders', JSON.stringify(orders));
                alert('Ordine annullato');
                loadOrders();
            }
        }

        function viewOrderDetails(orderId) {
            const orders = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
            const order = orders.find(o => (o.id || o.orderId) === orderId);
            
            if (order && order.pdfAccesses) {
                let details = `üì¶ Ordine #${orderId}\n\n`;
                details += `üìß Email inviata a: ${order.deliveryInfo?.email || order.email}\n\n`;
                details += `üìÑ Accessi PDF:\n\n`;
                order.pdfAccesses.forEach(pdf => {
                    details += `‚Ä¢ ${pdf.productName}\n`;
                        details += `  üîó ${pdf.accessUrl}\n`;
                        details += `  ‚è∞ Valido fino al: ${pdf.expiryDate || 'N/D'}\n\n`;
                });
                alert(details);
            }
        }

        // Genera password (stessa logica di success.html)
        function generatePassword(sessionId, productId) {
            const seed = `${sessionId}-${productId}`;
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                const char = seed.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            let num = Math.abs(hash);
            
            for (let i = 0; i < 12; i++) {
                password += chars[num % chars.length];
                num = Math.floor(num / chars.length) + (seed.charCodeAt(i % seed.length) || 1);
            }
            
            return password;
        }
    </script>
</body>
</html>
