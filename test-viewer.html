<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Viewer PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #0f172a; }
        h2 { color: #4a6fa5; margin-top: 20px; }
        .button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #3a7acc;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #4a90e2;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
        }
        .product-list {
            list-style: none;
            padding: 0;
        }
        .product-list li {
            background: #f9f9f9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #4a90e2;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="test-box">
        <h1>ðŸ”§ Test Viewer PDF</h1>
        <p>Questa pagina simula un ordine e genera link di accesso al viewer PDF protetto.</p>
    </div>

    <div class="test-box">
        <h2>Prodotti Disponibili</h2>
        <ul class="product-list" id="productsList"></ul>
        <div class="info">
            ðŸ’¡ Clicca su un prodotto per generare un link di accesso al viewer
        </div>
    </div>

    <div class="test-box">
        <h2>Link Generati</h2>
        <div id="linksContainer"></div>
    </div>

    <script src="products-data.js"></script>
    <script>
        // Prodotti digitali
        const digitalProducts = products.filter(p => p.tipo === 'digitale');

        // Carica lista prodotti
        const productsList = document.getElementById('productsList');
        digitalProducts.forEach(product => {
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${product.title}</strong> (ID: ${product.id})<br>
                <small>Prezzo: â‚¬${product.prezzo.toFixed(2)}</small><br>
                <button class="button" onclick="generateLink(${product.id})">
                    Apri Viewer â†’
                </button>
            `;
            productsList.appendChild(li);
        });

        function generateLink(productId) {
            // Simula un ordine
            const orderId = 'TEST-' + Date.now();
            const password = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            // Salva su localStorage per il test
            const testOrder = {
                id: orderId,
                order_id: orderId,
                user_email: 'test@example.com',
                items: [
                    {
                        id: productId,
                        productId: productId,
                        title: products.find(p => p.id === productId).title,
                        tipo: 'digitale',
                        prezzo: products.find(p => p.id === productId).prezzo
                    }
                ]
            };
            
            let orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(testOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            // Genera link
            const viewerUrl = `viewer-pdf.html?order=${orderId}&pwd=${password}&product=${productId}`;
            const fullUrl = `${window.location.origin}/${viewerUrl}`;
            
            // Mostra link
            const container = document.getElementById('linksContainer');
            const div = document.createElement('div');
            div.style.cssText = 'background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #4a90e2;';
            div.innerHTML = `
                <p><strong>âœ… Ordine Creato</strong></p>
                <p>ID Ordine: <code>${orderId}</code></p>
                <p>Password: <code>${password}</code></p>
                <p>Prodotto: <code>${productId}</code></p>
                <p style="word-break: break-all;"><strong>Link:</strong><br><code>${viewerUrl}</code></p>
                <p>
                    <button class="button" onclick="window.open('${viewerUrl}', '_blank')">
                        Apri in Nuova Tab â†’
                    </button>
                    <button class="button" style="background: #666;" onclick="navigator.clipboard.writeText('${fullUrl}'); alert('Copiato!')">
                        Copia Link
                    </button>
                </p>
            `;
            container.insertBefore(div, container.firstChild);
            
            // Apri viewer
            window.open(viewerUrl, '_blank');
        }

        // Mostra info
        console.log('Prodotti digitali disponibili:', digitalProducts);
        console.log('localStorage orders:', localStorage.getItem('orders'));
    </script>
</body>
</html>
